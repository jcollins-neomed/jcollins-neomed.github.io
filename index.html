<h1>Jason's Lottery Helper Tool</h1>

<h2>Choose Filters</h2>
<select id="dropdown">
  <option value="">--Choose City--</option>
  <option value="Akron">Akron</option>
  <option value="Cleveland">Cleveland</option>
  <option value="Youngstown">Youngstown</option>
  <option value="Columbus">Columbus</option>
</select>

<label for="mode">Filter Mode:</label>
<select id="mode">
  <option value="city">City Only</option>
  <option value="rotation">Rotation Only</option>
  <option value="and">City AND Rotation</option>
  <option value="or">City OR Rotation</option>
</select>

<button id="searchBtn">Search</button>

<div id="filterGrid"></div>
<div id="result"></div>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
  table { border-collapse: collapse; margin-top: 1em; width: 100%; }
  th, td { border: 1px solid #ccc; padding: 4px 6px; text-align: center; vertical-align: top; }
  th { background: #f2f2f2; }
  .rotation { display: block; padding: 2px 6px; margin-bottom: 2px; border-radius: 4px; color: #fff; font-size: 0.85em; }
  .site { font-size: 0.8em; color: #555; }
  .grid-table { margin-top:1em; border-collapse: collapse; }
  .grid-table th, .grid-table td { border:1px solid #ddd; padding:4px; text-align:center; }
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const dropdown = document.getElementById('dropdown');
  const modeSelect = document.getElementById('mode');
  const searchBtn = document.getElementById('searchBtn');
  const resultDiv = document.getElementById('result');
  const filterGridDiv = document.getElementById('filterGrid');

  const numBlocks = 9;
  const specialties = [
    'Surgery Clerkship',
    'Obstetric/Gynecology Clerkship',
    'Family Medicine Clerkship',
    'Psychiatry Clerkship',
    'Internal Medicine Clerkship',
    'Emergency Medicine Clerkship',
    'Pediatrics Clerkship',
    'Elective'
  ];

  // Build pre-checked filter grid
  let gridHTML = '<table class="grid-table"><thead><tr><th>Rotation</th>';
  for (let i = 1; i <= numBlocks; i++) gridHTML += `<th>${i}</th>`;
  gridHTML += '</tr></thead><tbody>';
  specialties.forEach(spec => {
    gridHTML += `<tr><td>${spec}</td>`;
    for (let i = 1; i <= numBlocks; i++) {
      gridHTML += `<td><input type="checkbox" data-rotation="${spec}" data-block="${i}" checked></td>`;
    }
    gridHTML += '</tr>';
  });
  gridHTML += '</tbody></table>';
  filterGridDiv.innerHTML = `<strong>Allowed Rotations (uncheck to exclude):</strong>${gridHTML}`;

  const specialtyColors = {
    'Surgery Clerkship': '#9C27B0',
    'Obstetric/Gynecology Clerkship': '#E91E63',
    'Family Medicine Clerkship': '#4CAF50',
    'Psychiatry Clerkship': '#795548',
    'Internal Medicine Clerkship': '#2196F3',
    'Emergency Medicine Clerkship': '#3F51B5',
    'Pediatrics Clerkship': '#FF9800',
    'Elective': '#9E9E9E'
  };
  const colorFor = s => specialtyColors[s] || '#607D8B';

  async function searchCSV() {
    const choice = dropdown.value.trim();
    const mode = modeSelect.value;

    // Collect unchecked boxes (excluded)
    const excluded = {};
    filterGridDiv.querySelectorAll('input[type="checkbox"]:not(:checked)').forEach(cb => {
      const rot = cb.dataset.rotation;
      const blk = cb.dataset.block;
      if (!excluded[blk]) excluded[blk] = new Set();
      excluded[blk].add(rot);
    });

    const rotationFilterActive = Object.keys(excluded).length > 0;

    try {
      const resp = await fetch('schedules.csv');
      const text = await resp.text();
      const parsed = Papa.parse(text, {
        header: true,
        skipEmptyLines: true,
        transformHeader: h => h.replace(/^\uFEFF/, '').trim()
      });

      const headers = Object.keys(parsed.data[0]);
      const idKey = headers.find(h => h.trim().toLowerCase().includes('id')) || headers[0];

      const filtered = parsed.data.filter(r => {
        const cityMatch = choice && (r['Dominant City'] || '').trim() === choice;

        let rotationAllowed = true;
        if (rotationFilterActive) {
          for (let i = 1; i <= numBlocks; i++) {
            const rotation = (r[`Block ${i} Rotation`] || '').trim();
            if (excluded[i] && excluded[i].has(rotation)) {
              rotationAllowed = false;
              break;
            }
          }
        }

        switch (mode) {
          case 'city':
            return cityMatch;
          case 'rotation':
            return rotationAllowed;
          case 'and':
            return cityMatch && rotationAllowed;
          case 'or':
            return cityMatch || rotationAllowed;
          default:
            return true;
        }
      });

      if (!filtered.length) { resultDiv.textContent = 'No matches found.'; return; }

      const head = Array.from({length: numBlocks}, (_, i) => `<th>Block ${i+1}</th>`).join('');
      let html = `<table><thead><tr><th>Schedule</th>${head}</tr></thead><tbody>`;

      filtered.forEach(r => {
        const sched = (r[idKey] || '').toString().trim();
        const cells = [];
        for (let i = 1; i <= numBlocks; i++) {
          const rotation = (r[`Block ${i} Rotation`] || '').trim();
          const site = (r[`Block ${i} Site`] || '').trim();
          cells.push(
            `<td>
               <span class="rotation" style="background-color:${colorFor(rotation)}">${rotation}</span>
               <div class="site">${site}</div>
             </td>`
          );
        }
        html += `<tr><td>${sched}</td>${cells.join('')}</tr>`;
      });

      html += '</tbody></table>';
      resultDiv.innerHTML = `<strong>Results:</strong><br>${html}`;
    } catch (e) {
      console.error(e);
      resultDiv.textContent = 'Error reading CSV file.';
    }
  }

  searchBtn.addEventListener('click', searchCSV);
});
</script>
