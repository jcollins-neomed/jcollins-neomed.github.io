<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jason's Lottery Helper Tool</title>
    <!-- Load PapaParse for CSV handling -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f9fafb;
            color: #333;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .app-title {
            text-align: center;
            font-size: 2rem;
            margin-bottom: 20px;
            color: #2c3e50;
        }
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        }
        .control-group {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        #addMessage {
            margin-left: 10px;
            font-size: 0.9em;
            color: #4CAF50;
            font-weight: 500;
        }
        label {
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
            font-size: 0.9rem;
        }
        .styled-select, .btn-primary, .btn-secondary {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #ccc;
            font-size: 1rem;
            background-color: #fff;
        }
        .btn-primary, .btn-secondary {
            border: none;
            cursor: pointer;
            transition: background-color 0.2s ease, box-shadow 0.2s ease;
        }
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        .btn-secondary:hover {
            background-color: #5a6268;
        }
        .btn-primary {
            background-color: #007bff;
            color: white;
        }
        .btn-primary:hover {
            background-color: #0069d9;
        }
        .btn-danger {
            background-color: #f44336;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background-color 0.2s ease;
        }
        .btn-danger:hover {
            background-color: #d32f2f;
        }
        
        /* --- Star Rating Styles --- */
        .star-rating-container {
            min-width: 140px; /* Give stars room */
            text-align: center;
        }
        .star {
            font-size: 1.75rem; /* Make stars bigger */
            color: #ccc;
            background: none;
            border: none;
            cursor: pointer;
            padding: 0 1px;
            transition: color 0.2s ease, transform 0.1s ease;
            line-height: 1;
        }
        .star:hover {
            color: #f39c12; /* Hover color */
            transform: scale(1.1);
        }
        .star.filled {
            color: #f1c40f; /* Filled color */
        }
        /* Stars in the rank list (display only) */
        .rank-item-rating {
            display: flex;
            gap: 2px;
            font-size: 1.2rem;
            color: #f1c40f;
        }
        .rank-item-rating .star {
            font-size: 1.2rem;
            color: #ccc;
            padding: 0;
            cursor: default;
        }
         .rank-item-rating .star:hover {
            color: #ccc; /* No hover effect */
            transform: none;
        }
        .rank-item-rating .star.filled {
            color: #f1c40f;
        }
        /* --- End Star Styles --- */

        table {
            border-collapse: collapse;
            margin-top: 1em;
            width: 100%;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }
        th, td {
            border-bottom: 1px solid #eee;
            padding: 10px 12px;
            text-align: center;
            vertical-align: middle;
        }
        th {
            background: #f3f4f6;
            font-weight: 600;
            color: #374151;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        tr:hover {
            background-color: #f9fafb;
        }
        
        .rotation {
            display: inline-block;
            padding: 4px 8px;
            margin-bottom: 4px;
            border-radius: 4px;
            color: #fff;
            font-size: 0.85em;
            font-weight: 500;
        }
        .site {
            font-size: 0.8em;
            color: #555;
            display: block; /* Ensure it wraps */
        }
        .grid-table {
            border-collapse: collapse;
            margin: 20px auto;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }
        .grid-table th, .grid-table td {
            padding: 6px 8px;
            border-bottom: 1px solid #eee;
            text-align: center;
        }
        #filterGrid strong {
            display: block;
            text-align: center;
            margin-bottom: 10px;
            font-size: 1.1rem;
            color: #2c3e50;
        }

        /* --- New Styles for Rank List Section --- */
        .rank-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }
        .rank-list-header .rank-message {
            margin-left: 10px;
            font-size: 0.9em;
        }
        .rank-list-ul { /* Changed from ol to ul */
            list-style-type: none; /* No numbers */
            padding-left: 0;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            padding: 10px;
            margin: 0;
        }
        .rank-list-ul li {
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: block; 
            font-size: 1.1rem;
        }
        .rank-list-ul li:last-child {
            border-bottom: none;
        }
        .rank-list-ul li .rank-item-name {
            font-weight: 600;
            color: #333;
        }
        .rank-list-ul li .rank-item-city {
            font-size: 0.9rem;
            color: #777;
            margin-left: 8px;
        }
        .rank-list-ul li .rank-controls {
            display: flex;
            align-items: center;
            gap: 15px; /* More space for stars */
        }
        .rank-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px; 
            flex-wrap: wrap;
            gap: 10px;
        }
        .rank-item-details {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            padding: 8px;
            background-color: #f7f7f7;
            border-radius: 4px;
            border: 1px solid #f0f0f0;
        }
        .rank-block {
            flex: 1; 
            min-width: 80px; 
            padding: 6px;
            border: 1px solid #e5e5e5;
            border-radius: 4px;
            background: #fff;
            text-align: center;
            font-size: 0.8rem; 
        }
        .rank-block-number {
            font-weight: bold;
            font-size: 0.9em;
            color: #333;
            margin-bottom: 4px;
        }
        .rank-block .rotation {
            font-size: 0.9em; 
            padding: 2px 4px;
        }
        .rank-block .site {
            font-size: 0.85em;
            margin-top: 4px; 
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="app-title">Jason's Lottery Helper Tool</h1>

        <section class="controls">
            <div class="control-group">
                <label for="dropdown">City:</label>
                <select id="dropdown" class="styled-select">
                    <option value="">--All Cities--</option>
                    <option value="Akron">Akron</option>
                    <option value="Eastern Cleveland">Eastern Cleveland</option>
                    <option value="Western Cleveland">Western Cleveland</option>
                    <option value="Youngstown">Youngstown</option>
                    <option value="Columbus">Columbus</option>
                    <option value="Rootstown">Rootstown</option>
                    <option value="Canton">Canton</option>
                </select>
            </div>
        
            <div class="control-group">
                <label for="mode">Filter Mode:</label>
                <select id="mode" class="styled-select">
                    <option value="city">City Only</option>
                    <option value="rotation">Rotation Only</option>
                    <option value="and">City AND Rotation</option>
                </select>
            </div>
        
            <button id="searchBtn" class="btn-primary">Search</button>
            <button id="viewRankListBtn" class="btn-secondary">
                View Rank List (<span id="rankCount">0</span>)
            </button>
            <span id="addMessage"></span> <!-- For "Rating saved!" messages -->
        </section>

        <!-- This 'main' tag now wraps the original search/filter/results sections -->
        <main id="searchSection">
            <section id="filterGrid"></section>
            <section id="result"></section>
        </main>

        <!-- New, hidden section for the Rank List -->
        <section id="rankListSection" style="display: none;">
            <input type="file" id="uploadCSVInput" accept=".csv" style="display: none;"> <!-- Hidden file input -->
            <div class="rank-list-header">
                <h2 class="app-title" style="margin: 0;">My Rank List</h2>
                <div>
                    <button id="backToSearchBtn" class="btn-secondary">‚Üê Back to Search</button>
                    <button id="uploadCSVBtn" class="btn-secondary">Upload CSV</button> <!-- Upload button -->
                    <button id="downloadCSVBtn" class="btn-primary">Download as CSV</button>
                    <span id="rankListMessage" class="rank-message"></span>
                </div>
            </div>
            <p id="rankListEmpty" style="text-align: center; display: none; padding: 20px;">Your rank list is empty. Go back to search to add ratings.</p>
            <!-- Changed to <ul> -->
            <ul id="rankListItems" class="rank-list-ul"></ul>
        </section>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const dropdown = document.getElementById('dropdown');
        const modeSelect = document.getElementById('mode');
        const searchBtn = document.getElementById('searchBtn');
        const resultDiv = document.getElementById('result');
        const filterGridDiv = document.getElementById('filterGrid');

        // New Rank List elements
        const searchSection = document.getElementById('searchSection');
        const rankListSection = document.getElementById('rankListSection');
        const viewRankListBtn = document.getElementById('viewRankListBtn');
        const backToSearchBtn = document.getElementById('backToSearchBtn');
        const downloadCSVBtn = document.getElementById('downloadCSVBtn');
        const uploadCSVBtn = document.getElementById('uploadCSVBtn'); 
        const uploadCSVInput = document.getElementById('uploadCSVInput');
        const rankListItems = document.getElementById('rankListItems');
        const rankCountSpan = document.getElementById('rankCount');
        const addMessageSpan = document.getElementById('addMessage');
        const rankListEmptyP = document.getElementById('rankListEmpty');
        const rankListMessageSpan = document.getElementById('rankListMessage');

        // Global state for rank list
        // Now an array of { schedule: Object, rating: Number }
        let rankList = []; 
        let allSchedules = []; // Store all schedules from the main CSV
        // To be populated by CSV parse
        let idKey, cityKey;

        const numBlocks = 9;
        const specialties = [
            'Surgery','Obstetric/Gynecology','Family Medicine',
            'Psychiatry','Internal Medicine','Emergency Medicine',
            'Pediatrics','Elective'
        ];

        // Build grid
        let gridHTML = '<table class="grid-table"><thead><tr><th>Rotation</th>';
        for (let i = 1; i <= numBlocks; i++) gridHTML += `<th>${i}</th>`;
        gridHTML += '</tr></thead><tbody>';
        specialties.forEach(spec => {
            gridHTML += `<tr><td>${spec}</td>`;
            for (let i = 1; i <= numBlocks; i++) {
            gridHTML += `<td><input type="checkbox" data-rotation="${spec}" data-block="${i}" checked></td>`;
            }
            gridHTML += '</tr>';
        });
        gridHTML += '</tbody></table>';
        filterGridDiv.innerHTML = `<strong>Allowed Rotations (uncheck to exclude):</strong>${gridHTML}`;

        const specialtyColors = {
            'Surgery':'#9C27B0','Obstetric/Gynecology':'#E91E63',
            'Family Medicine':'#4CAF50','Psychiatry':'#795548',
            'Internal Medicine':'#2196F3','Emergency Medicine':'#3F51B5',
            'Pediatrics':'#FF9800','Elective':'#9E9E9E'
        };
        const colorFor = s => specialtyColors[s] || '#607D8B';

        async function loadMasterSchedule() {
            if (allSchedules.length > 0) return true; // Already loaded

            try {
                // IMPORTANT: Make sure 'schedules.csv' is in the same directory
                // or update this path.
                const resp = await fetch('schedules.csv'); 
                if (!resp.ok) {
                    throw new Error(`Failed to fetch schedules.csv: ${resp.statusText}`);
                }
                const text = await resp.text();
                const parsed = Papa.parse(text,{
                    header:true, skipEmptyLines:true,
                    transformHeader:h=>h.replace(/^\uFEFF/,'').trim()
                });

                if(!parsed.data.length) {
                    console.error("Master schedule CSV empty or unreadable");
                    resultDiv.textContent = 'Error: Master schedule file is empty.';
                    return false;
                }
                
                // Store all data
                allSchedules = parsed.data;

                // Detect actual city key dynamically
                const headers = Object.keys(allSchedules[0]);
                // Set global keys if not already set
                if (!cityKey) {
                    cityKey = headers.find(k=>k.trim().toLowerCase().includes('city')) || 'Dominant City';
                }
                if (!idKey) {
                    idKey = headers.find(k=>k.trim().toLowerCase().includes('id')) || headers[0];
                }
                console.log(`Using ID Key: '${idKey}', City Key: '${cityKey}'`);
                return true; // Success

            } catch (e) {
                console.error("Error loading master schedule:", e);
                resultDiv.textContent = 'Error: Could not load master schedule file (schedules.csv). Make sure it exists.';
                return false; // Failure
            }
        }


        // --- View Toggling ---
        function showSection(sectionToShow) {
            if (sectionToShow === 'rank') {
                searchSection.style.display = 'none';
                rankListSection.style.display = 'block';
                renderRankList(); // Re-render the list every time we show it
            } else {
                searchSection.style.display = 'block';
                rankListSection.style.display = 'none';
            }
        }

        viewRankListBtn.addEventListener('click', () => showSection('rank'));
        backToSearchBtn.addEventListener('click', () => showSection('search'));

        // --- Rank List Logic ---
        function renderRankList() {
            rankListItems.innerHTML = ''; // Clear existing list
            rankCountSpan.textContent = rankList.length;

            if (rankList.length === 0) {
                rankListEmptyP.style.display = 'block';
                rankListItems.style.display = 'none';
                return;
            }

            // Sort by rating (descending) and then by custom rankOrder (ascending)
            rankList.sort((a, b) => b.rating - a.rating || a.rankOrder - b.rankOrder);

            // Modified CSV content: Schedule ID and Rating
            let csvContent = "Schedule ID,Rating\n";
            rankList.forEach((item) => {
                const id = (idKey && item.schedule[idKey]) ? item.schedule[idKey] : '';
                const rating = item.rating;
                csvContent += `"${id.replace(/"/g, '""')}",${rating}\n`;
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "my_schedule_ratings.csv");
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });


        async function searchCSV(doLoad = true) {
            const choice = dropdown.value.trim();
            const mode = modeSelect.value;

            // collect unchecked
            const excluded = {};
            filterGridDiv.querySelectorAll('input[type="checkbox"]:not(:checked)').forEach(cb=>{
                const rot = cb.dataset.rotation, blk = cb.dataset.block;
                if(!excluded[blk]) excluded[blk]=new Set(); excluded[blk].add(rot);
            });
            const rotationFilterActive = Object.keys(excluded).length>0;

            try {
                // Ensure master schedule is loaded
                if (doLoad && allSchedules.length === 0) {
                    addMessageSpan.textContent = 'Loading master schedule...';
                    addMessageSpan.style.color = '#555';
                    const success = await loadMasterSchedule();
                    addMessageSpan.textContent = ''; // Clear message
                    if (!success) {
                        resultDiv.textContent='Error reading CSV file.';
                        return;
                    }
                } else if (allSchedules.length === 0) {
                    // This can happen if searchCSV(false) is called before load
                    console.log("Master schedule not loaded, skipping render.");
                    return;
                }
                
                // Master schedule is loaded, allSchedules, idKey, and cityKey are set.
                // Now, just do the filtering and rendering.

                const filtered = allSchedules.filter(r=>{
                    // Allow empty city choice to show all
                    const cityMatch = !choice || (r[cityKey]||'').trim()===choice;
                    let rotationAllowed=true;
                    if(rotationFilterActive){
                        for(let i=1;i<=numBlocks;i++){
                        const rotation=(r[`Block ${i} Rotation`]||'').trim();
                        if(excluded[i]&&excluded[i].has(rotation)){ rotationAllowed=false; break;}
                        }
                    }
                    switch(mode){
                        case 'city': return cityMatch;
                        case 'rotation': return rotationAllowed;
                        case 'and': return cityMatch && rotationAllowed;
                        default: return true;
                    }
                });

                if(!filtered.length){ resultDiv.textContent='No matches found.'; return;}

                const head = Array.from({length:numBlocks},(_,i)=>`<th>Block ${i+1}</th>`).join('');
                // Modified header to include 'Rating' and 'Schedule'
                let html=`<table><thead><tr><th>Rating</th><th>Schedule</th>${head}</tr></thead><tbody>`;
                
                filtered.forEach(r=>{
                    const sched=(r[idKey]||'').toString().trim();
                    // Check if this item is in the rank list to set button state
                    const currentRating = rankList.find(item => item.schedule[idKey] === sched)?.rating || 0;

                    const cells=[];
                    for(let i=1;i<=numBlocks;i++){
                        const rotation=(r[`Block ${i} Rotation`]||'').trim();
                        const site=(r[`Block ${i} Site`] ||'').trim();
                        cells.push(
                        `<td>
                            <span class="rotation" style="background-color:${colorFor(rotation)}">${rotation || 'N/A'}</span>
                            <div class="site">${site || '-'}</div>
                            </td>`
                        );
                    }
                    
                    // Add the star rating column
                    const rowDataString = JSON.stringify(r).replace(/'/g, "&apos;");
                    let starsHTML = `<td class="star-rating-container" data-row='${rowDataString}'>`;
                    for (let i = 1; i <= 5; i++) {
                        starsHTML += `<button 
                                        class="star ${i <= currentRating ? 'filled' : ''}" 
                                        data-value="${i}" 
                                        data-id="${sched}" 
                                        aria-label="${i} star"
                                      >&#9733;</button>`;
                    }
                    starsHTML += `</td>`;

                    html+=`<tr>${starsHTML}<td>${sched}</td>${cells.join('')}</tr>`;
                });
                html+='</tbody></table>';
                resultDiv.innerHTML=`<strong>Results: (${filtered.length})</strong><br>${html}`;
            } catch(e){
                console.error(e);
                resultDiv.textContent='Error reading CSV file.';
            }
        }

        searchBtn.addEventListener('click', () => searchCSV(true));

        // Initial load
        loadMasterSchedule();
    });
    </script>
</body>
</html>


