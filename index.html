<h1 class="app-title">Jason's Lottery Helper Tool</h1>

<section class="controls">
  <div class="control-group">
    <label for="dropdown">City:</label>
    <select id="dropdown" class="styled-select">
      <option value="">--Choose City--</option>
      <option value="Akron">Akron</option>
      <option value="Cleveland">Cleveland</option>
      <option value="Youngstown">Youngstown</option>
      <option value="Columbus">Columbus</option>
    </select>
  </div>

  <div class="control-group">
    <label for="mode">Filter Mode:</label>
    <select id="mode" class="styled-select">
      <option value="city">City Only</option>
      <option value="rotation">Rotation Only</option>
      <option value="and">City AND Rotation</option>
    </select>
  </div>

  <button id="searchBtn" class="btn-primary">Search</button>
</section>

<section id="filterGrid"></section>
<section id="result"></section>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
  body {
    font-family: Arial, Helvetica, sans-serif;
    background-color: #f9fafb;
    color: #333;
    margin: 20px;
  }
  .app-title {
    text-align: center;
    font-size: 2rem;
    margin-bottom: 20px;
    color: #2c3e50;
  }
  .controls {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    justify-content: center;
    align-items: center;
    margin-bottom: 20px;
  }
  .control-group {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
  }
  label {
    margin-bottom: 5px;
    font-weight: bold;
    color: #555;
  }
  .styled-select, .btn-primary {
    padding: 8px 12px;
    border-radius: 6px;
    border: 1px solid #ccc;
    font-size: 1rem;
  }
  .btn-primary {
    background-color: #4CAF50;
    color: white;
    border: none;
    cursor: pointer;
    transition: background-color 0.2s ease;
  }
  .btn-primary:hover {
    background-color: #45a049;
  }
  table {
    border-collapse: collapse;
    margin-top: 1em;
    width: 100%;
    background: white;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  }
  th, td {
    border-bottom: 1px solid #eee;
    padding: 8px 10px;
    text-align: center;
  }
  th {
    background: #f3f4f6;
    font-weight: 600;
    color: #374151;
  }
  tr:hover {
    background-color: #f9fafb;
  }
  .rotation {
    display: inline-block;
    padding: 3px 6px;
    margin-bottom: 4px;
    border-radius: 4px;
    color: #fff;
    font-size: 0.85em;
  }
  .site {
    font-size: 0.8em;
    color: #555;
  }
  .grid-table {
    border-collapse: collapse;
    margin: 20px auto;
    background: white;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  }
  .grid-table th, .grid-table td {
    padding: 6px 8px;
    border-bottom: 1px solid #eee;
    text-align: center;
  }
  #filterGrid strong {
    display: block;
    text-align: center;
    margin-bottom: 10px;
    font-size: 1.1rem;
    color: #2c3e50;
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const dropdown = document.getElementById('dropdown');
  const modeSelect = document.getElementById('mode');
  const searchBtn = document.getElementById('searchBtn');
  const resultDiv = document.getElementById('result');
  const filterGridDiv = document.getElementById('filterGrid');

  const numBlocks = 9;
  const specialties = [
    'Surgery Clerkship',
    'Obstetric/Gynecology Clerkship',
    'Family Medicine Clerkship',
    'Psychiatry Clerkship',
    'Internal Medicine Clerkship',
    'Emergency Medicine Clerkship',
    'Pediatrics Clerkship',
    'Elective'
  ];

  // Build pre-checked filter grid
  let gridHTML = '<table class="grid-table"><thead><tr><th>Rotation</th>';
  for (let i = 1; i <= numBlocks; i++) gridHTML += `<th>${i}</th>`;
  gridHTML += '</tr></thead><tbody>';
  specialties.forEach(spec => {
    gridHTML += `<tr><td>${spec}</td>`;
    for (let i = 1; i <= numBlocks; i++) {
      gridHTML += `<td><input type="checkbox" data-rotation="${spec}" data-block="${i}" checked></td>`;
    }
    gridHTML += '</tr>';
  });
  gridHTML += '</tbody></table>';
  filterGridDiv.innerHTML = `<strong>Allowed Rotations (uncheck to exclude):</strong>${gridHTML}`;

  const specialtyColors = {
    'Surgery Clerkship': '#9C27B0',
    'Obstetric/Gynecology Clerkship': '#E91E63',
    'Family Medicine Clerkship': '#4CAF50',
    'Psychiatry Clerkship': '#795548',
    'Internal Medicine Clerkship': '#2196F3',
    'Emergency Medicine Clerkship': '#3F51B5',
    'Pediatrics Clerkship': '#FF9800',
    'Elective': '#9E9E9E'
  };
  const colorFor = s => specialtyColors[s] || '#607D8B';

  async function searchCSV() {
    const choice = dropdown.value.trim();
    const mode = modeSelect.value;

    // Collect unchecked (excluded) combos
    const excluded = {};
    filterGridDiv.querySelectorAll('input[type="checkbox"]:not(:checked)').forEach(cb => {
      const rot = cb.dataset.rotation;
      const blk = cb.dataset.block;
      if (!excluded[blk]) excluded[blk] = new Set();
      excluded[blk].add(rot);
    });

    const rotationFilterActive = Object.keys(excluded).length > 0;

    try {
      const resp = await fetch('schedules.csv');
      const text = await resp.text();
      const parsed = Papa.parse(text, {
        header: true,
        skipEmptyLines: true,
        transformHeader: h => h.replace(/^\uFEFF/, '').trim()
      });

      const headers = Object.keys(parsed.data[0]);
      const idKey = headers.find(h => h.trim().toLowerCase().includes('id')) || headers[0];

      const filtered = parsed.data.filter(r => {
        const cityMatch = choice && (r['Dominant City'] || '').trim() === choice;

        let rotationAllowed = true;
        if (rotationFilterActive) {
          for (let i = 1; i <= numBlocks; i++) {
            const rotation = (r[`Block ${i} Rotation`] || '').trim();
            if (excluded[i] && excluded[i].has(rotation)) {
              rotationAllowed = false;
              break;
            }
          }
        }

        switch (mode) {
          case 'city': return cityMatch;
          case 'rotation': return rotationAllowed;
          case 'and': return cityMatch && rotationAllowed;
          default: return true;
        }
      });

      if (!filtered.length) { resultDiv.textContent = 'No matches found.'; return; }

      const head = Array.from({length: numBlocks}, (_, i) => `<th>Block ${i+1}</th>`).join('');
      let html = `<table><thead><tr><th>Schedule</th>${head}</tr></thead><tbody>`;

      filtered.forEach(r => {
        const sched = (r[idKey] || '').toString().trim();
        const cells = [];
        for (let i = 1; i <= numBlocks; i++) {
          const rotation = (r[`Block ${i} Rotation`] || '').trim();
          const site = (r[`Block ${i} Site`] || '').trim();
          cells.push(
            `<td>
               <span class="rotation" style="background-color:${colorFor(rotation)}">${rotation}</span>
               <div class="site">${site}</div>
             </td>`
          );
        }
        html += `<tr><td>${sched}</td>${cells.join('')}</tr>`;
      });

      html += '</tbody></table>';
      resultDiv.innerHTML = `<strong>Results:</strong><br>${html}`;
    } catch (e) {
      console.error(e);
      resultDiv.textContent = 'Error reading CSV file.';
    }
  }

  searchBtn.addEventListener('click', searchCSV);
});
</script>
