<h1 class="app-title">Jason's Lottery Helper Tool</h1>

<section class="controls">
  <div class="control-group">
    <label for="dropdown">City:</label>
    <select id="dropdown" class="styled-select">
      <option value="">--Choose City--</option>
      <option value="Akron">Akron</option>
      <option value="Eastern Cleveland">Eastern Cleveland</option>
      <option value="Western Cleveland">Western Cleveland</option>
      <option value="Youngstown">Youngstown</option>
      <option value="Columbus">Columbus</option>
      <option value="Rootstown">Rootstown</option>
      <option value="Canton">Canton</option>
    </select>
  </div>

  <div class="control-group">
    <label for="mode">Filter Mode:</label>
    <select id="mode" class="styled-select">
      <option value="city">City Only</option>
      <option value="rotation">Rotation Only</option>
      <option value="and">City AND Rotation</option>
    </select>
  </div>

  <!-- "View Rank List" button added -->
  <button id="searchBtn" class="btn-primary">Search</button>
  <button id="viewRankListBtn" class="btn-secondary">
    View Rank List (<span id="rankCount">0</span>)
  </button>
  <span id="addMessage"></span> <!-- For "Added!" or "Already in list" messages -->
</section>

<!-- This 'main' tag now wraps the original search/filter/results sections -->
<main id="searchSection">
  <section id="filterGrid"></section>
  <section id="result"></section>
</main>

<meta name="viewport" content="width=device-width, initial-scale=0.8">

<!-- New, hidden section for the Rank List -->
<section id="rankListSection" style="display: none;">
  <input type="file" id="uploadCSVInput" accept=".csv" style="display: none;"> <!-- Hidden file input -->
  <div class="rank-list-header">
    <h2 class="app-title">My Rank List</h2>
    <div>
      <button id="backToSearchBtn" class="btn-secondary">← Back to Search</button>
      <button id="uploadCSVBtn" class="btn-secondary">Upload CSV</button> <!-- Upload button -->
      <button id="downloadCSVBtn" class="btn-primary">Download as CSV</button>
      <span id="rankListMessage" class="rank-message"></span>
    </div>
  </div>
  <p id="rankListEmpty" style="text-align: center; display: none;">Your rank list is empty. Go back to search to add schedules.</p>
  <ol id="rankListItems" class="rank-list-ol"></ol>
</section>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
  body {
    font-family: Arial, Helvetica, sans-serif;
    background-color: #f9fafb;
    color: #333;
    margin: 20px;
  }
  .app-title {
    text-align: center;
    font-size: 2rem;
    margin-bottom: 20px;
    color: #2c3e50;
  }
  .controls {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    justify-content: center;
    align-items: center;
    margin-bottom: 20px;
  }
  .control-group {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
  }
  #addMessage {
    margin-left: 10px;
    font-size: 0.9em;
    color: #4CAF50;
  }
  label {
    margin-bottom: 5px;
    font-weight: bold;
    color: #555;
  }
  .styled-select, .btn-primary, .btn-secondary { /* Added .btn-secondary for consistent sizing */
    padding: 8px 12px;
    border-radius: 6px;
    border: 1px solid #ccc;
    font-size: 1rem;
  }

  /* Style for secondary/toggle buttons */
  .btn-secondary {
    background-color: #555;
    color: white;
    border: none;
    cursor: pointer;
    transition: background-color 0.2s ease;
  }
  .btn-secondary:hover {
    background-color: #333;
  }
  /* Style for danger/remove buttons */
  .btn-danger {
    background-color: #f44336;
    color: white;
    border: none;
    cursor: pointer;
    font-size: 0.8rem;
    padding: 2px 6px;
    border-radius: 4px;
    transition: background-color 0.2s ease;
  }
  .btn-danger:hover {
    background-color: #d32f2f;
  }
  /* Style for small rank-list buttons */
  .btn-rank {
    background-color: #f0f0f0;
    color: #333;
    border: 1px solid #ccc;
    cursor: pointer;
    font-size: 1rem;
    padding: 0px 6px;
    border-radius: 4px;
    margin: 0 2px;
    line-height: 1.2;
  }
  .btn-rank:hover {
    background-color: #e0e0e0;
  }
  .btn-rank:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .btn-primary {
    background-color: #4CAF50;
    color: white;
    border: none;
    cursor: pointer;
    transition: background-color 0.2s ease;
  }
  .btn-primary:hover {
    background-color: #45a049;
  }
  table {
    border-collapse: collapse;
    margin-top: 1em;
    width: 100%;
    background: white;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  }
  th, td {
    border-bottom: 1px solid #eee;
    padding: 8px 10px;
    text-align: center;
  }
  th {
    background: #f3f4f6;
    font-weight: 600;
    color: #374151;
  }
  tr:hover {
    background-color: #f9fafb;
  }
  /* Class for the 'Add' button in the results table */
  .btn-add {
    font-size: 1.2rem;
    font-weight: bold;
    color: #4CAF50;
    background: none;
    border: none;
    cursor: pointer;
    padding: 4px 8px;
    border-radius: 50%;
  }
  .btn-add:hover {
    background-color: #e8f5e9;
  }
  .btn-add:disabled {
    color: #ccc;
    cursor: not-allowed;
    background: none;
  }
  .rotation {
    display: inline-block;
    padding: 3px 6px;
    margin-bottom: 4px;
    border-radius: 4px;
    color: #fff;
    font-size: 0.85em;
  }
  .site {
    font-size: 0.8em;
    color: #555;
  }
  .grid-table {
    border-collapse: collapse;
    margin: 20px auto;
    background: white;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  }
  .grid-table th, .grid-table td {
    padding: 6px 8px;
    border-bottom: 1px solid #eee;
    text-align: center;
  }
  #filterGrid strong {
    display: block;
    text-align: center;
    margin-bottom: 10px;
    font-size: 1.1rem;
    color: #2c3e50;
  }

  /* New Styles for Rank List Section */
  .rank-list-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    flex-wrap: wrap;
    gap: 10px;
  }
  .rank-list-header .rank-message {
    margin-left: 10px;
    font-size: 0.9em;
  }
  .rank-list-ol {
    list-style-type: decimal;
    padding-left: 30px;
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    padding: 20px;
    padding-left: 50px; /* Make space for numbers */
    margin: 0;
  }
  .rank-list-ol li {
    padding: 12px 8px;
    border-bottom: 1px solid #eee;
    display: block; /* Changed from flex to block */
    font-size: 1.1rem;
  }
  .rank-list-ol li:last-child {
    border-bottom: none;
  }
  .rank-list-ol li .rank-item-name {
    font-weight: 600;
    color: #333;
  }
  .rank-list-ol li .rank-item-city {
    font-size: 0.9rem;
    color: #777;
    margin-left: 8px;
  }
  .rank-list-ol li .rank-controls {
    display: flex;
    align-items: center;
    gap: 5px;
  }

  /* New styles for the expanded rank list view */
  .rank-item-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px; /* Add some space below header */
  }

  .rank-item-details {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    padding: 8px;
    background-color: #f_f_f; /* Slightly off-white background */
    border-radius: 4px;
    border: 1px solid #f0f0f0;
  }

  .rank-block {
    flex: 1; /* Allow blocks to grow and fill space */
    min-width: 80px; /* Set a min-width for each block */
    padding: 6px;
    border: 1px solid #e5e5e5;
    border-radius: 4px;
    background: #fff;
    text-align: center;
    font-size: 0.8rem; /* Smaller font for detail view */
  }

  .rank-block-number {
    font-weight: bold;
    font-size: 0.9em;
    color: #333;
    margin-bottom: 4px;
  }

  /* Adjust existing rotation/site styles for this context */
  .rank-block .rotation {
    font-size: 0.9em; /* Ensure font size is consistent */
    padding: 2px 4px;
  }
  .rank-block .site {
    font-size: 0.85em;
    margin-top: 4px; /* Add space above site name */
  }

      /* Remove the spinner arrows in number inputs */
    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    
    input[type="number"] {
      -moz-appearance: textfield; /* For Firefox */
    }


</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const dropdown = document.getElementById('dropdown');
  const modeSelect = document.getElementById('mode');
  const searchBtn = document.getElementById('searchBtn');
  const resultDiv = document.getElementById('result');
  const filterGridDiv = document.getElementById('filterGrid');
  const controlsSection = document.querySelector('.controls');

  const searchSection = document.getElementById('searchSection');
  const rankListSection = document.getElementById('rankListSection');
  const viewRankListBtn = document.getElementById('viewRankListBtn');
  const backToSearchBtn = document.getElementById('backToSearchBtn');
  const downloadCSVBtn = document.getElementById('downloadCSVBtn');
  const uploadCSVBtn = document.getElementById('uploadCSVBtn');
  const uploadCSVInput = document.getElementById('uploadCSVInput');
  const rankListItems = document.getElementById('rankListItems');
  const rankCountSpan = document.getElementById('rankCount');
  const addMessageSpan = document.getElementById('addMessage');
  const rankListEmptyP = document.getElementById('rankListEmpty');
  const rankListMessageSpan = document.getElementById('rankListMessage');

  let rankList = [];
  let allSchedules = [];
  let idKey, cityKey;

  const numBlocks = 9;
  const specialties = [
    'Surgery','Obstetrics/Gynecology','Family Medicine',
    'Psychiatry','Internal Medicine','Emergency Medicine',
    'Pediatrics','Elective'
  ];

  // Build grid
  let gridHTML = '<table class="grid-table"><thead><tr><th>Rotation</th>';
  for (let i = 1; i <= numBlocks; i++) gridHTML += `<th>${i}</th>`;
  gridHTML += '</tr></thead><tbody>';
  specialties.forEach(spec => {
    gridHTML += `<tr><td>${spec}</td>`;
    for (let i = 1; i <= numBlocks; i++) {
      gridHTML += `<td><input type="checkbox" data-rotation="${spec}" data-block="${i}" checked></td>`;
    }
    gridHTML += '</tr>';
  });
  gridHTML += '</tbody></table>';
  filterGridDiv.innerHTML = `<strong>Allowed Rotations (uncheck to exclude):</strong>${gridHTML}`;

  const specialtyColors = {
    'Surgery':'#9C27B0','Obstetrics/Gynecology':'#E91E63',
    'Family Medicine':'#4CAF50','Psychiatry':'#795548',
    'Internal Medicine':'#2196F3','Emergency Medicine':'#3F51B5',
    'Pediatrics':'#FF9800','Elective':'#9E9E9E'
  };
  const colorFor = s => specialtyColors[s] || '#607D8B';

  async function loadMasterSchedule() {
    if (allSchedules.length > 0) return true;
    try {
      const resp = await fetch('schedules.csv');
      const text = await resp.text();
      const parsed = Papa.parse(text,{
        header:true, skipEmptyLines:true,
        transformHeader:h=>h.replace(/^\uFEFF/,'').trim()
      });
      if(!parsed.data.length) return false;
      allSchedules = parsed.data;
      const headers = Object.keys(allSchedules[0]);
      if (!cityKey) cityKey = headers.find(k=>k.toLowerCase().includes('city')) || 'Dominant City';
      if (!idKey) idKey = headers.find(k=>k.toLowerCase().includes('id')) || headers[0];
      return true;
    } catch { return false; }
  }

  function showSection(sectionToShow) {
    if (sectionToShow === 'rank') {
      searchSection.style.display = 'none';
      rankListSection.style.display = 'block';
      controlsSection.style.display = 'none';
      renderRankList();
    } else {
      searchSection.style.display = 'block';
      rankListSection.style.display = 'none';
      controlsSection.style.display = 'flex';
    }
  }

  viewRankListBtn.addEventListener('click', () => showSection('rank'));
  backToSearchBtn.addEventListener('click', () => showSection('search'));

  function renderRankList() {
    rankListItems.innerHTML = '';
    rankCountSpan.textContent = rankList.length;

    if (rankList.length === 0) {
      rankListEmptyP.style.display = 'block';
      rankListItems.style.display = 'none';
      return;
    }

    rankListEmptyP.style.display = 'none';
    rankListItems.style.display = 'block';

    rankList.forEach((item, index) => {
      const li = document.createElement('li');
      const id = idKey ? item[idKey] : 'Unknown ID';
      const city = cityKey ? item[cityKey] : 'Unknown City';

      let headerHTML = `
        <div class="rank-item-header">
          <div>
            <input type="number" class="rank-input" min="1" max="${rankList.length}" value="${index + 1}" data-index="${index}" style="width:50px; margin-right:8px;">
            <span class="rank-item-name">${id}</span>
            <span class="rank-item-city">${city}</span>
          </div>
          <div class="rank-controls">
            <button class="btn-rank" data-index="${index}" ${index === 0 ? 'disabled' : ''} aria-label="Move up">↑</button>
            <button class="btn-rank" data-index="${index}" ${index === rankList.length - 1 ? 'disabled' : ''} aria-label="Move down">↓</button>
            <button class="btn-danger" data-index="${index}" aria-label="Remove">×</button>
          </div>
        </div>`;

      let detailsHTML = '<div class="rank-item-details">';
      for (let i = 1; i <= numBlocks; i++) {
        const rotation = (item[`Block ${i} Rotation`] || '').trim();
        const site = (item[`Block ${i} Site`] || '').trim();
        detailsHTML += `
          <div class="rank-block">
            <div class="rank-block-number">Block ${i}</div>
            <span class="rotation" style="background-color:${colorFor(rotation)}">${rotation || 'N/A'}</span>
            <div class="site">${site || '-'}</div>
          </div>`;
      }
      detailsHTML += '</div>';

      li.innerHTML = headerHTML + detailsHTML;
      rankListItems.appendChild(li);
    });
  }

  rankListItems.addEventListener('click', (e) => {
    const target = e.target.closest('button');
    if (!target) return;
    const index = parseInt(target.dataset.index, 10);

    if (target.classList.contains('btn-danger')) {
      rankList.splice(index, 1);
    } else if (target.getAttribute('aria-label') === 'Move up' && index > 0) {
      [rankList[index - 1], rankList[index]] = [rankList[index], rankList[index - 1]];
    } else if (target.getAttribute('aria-label') === 'Move down' && index < rankList.length - 1) {
      [rankList[index + 1], rankList[index]] = [rankList[index], rankList[index + 1]];
    }
    renderRankList();
  });

  // handle manual input reorder
  rankListItems.addEventListener('change', (e) => {
    if (e.target.classList.contains('rank-input')) {
      const oldIndex = parseInt(e.target.dataset.index, 10);
      let newIndex = parseInt(e.target.value, 10) - 1;
      if (isNaN(newIndex) || newIndex < 0 || newIndex >= rankList.length) {
        e.target.value = oldIndex + 1;
        return;
      }
      const [movedItem] = rankList.splice(oldIndex, 1);
      rankList.splice(newIndex, 0, movedItem);
      renderRankList();
    }
  });

  resultDiv.addEventListener('click', (e) => {
    const target = e.target.closest('.btn-add');
    if (!target) return;
    const schedId = target.dataset.id;
    if (idKey && rankList.some(item => item[idKey] === schedId)) {
      addMessageSpan.textContent = 'Already in list!';
      setTimeout(() => addMessageSpan.textContent = '', 2000);
      return;
    }
    try {
      const rowData = JSON.parse(target.dataset.row);
      rankList.push(rowData);
      rankCountSpan.textContent = rankList.length;
      target.textContent = '✓';
      target.disabled = true;
      addMessageSpan.textContent = 'Added!';
      setTimeout(() => addMessageSpan.textContent = '', 2000);
    } catch {
      addMessageSpan.textContent = 'Error adding item.';
      setTimeout(() => addMessageSpan.textContent = '', 2000);
    }
  });

  async function searchCSV() {
    const choice = dropdown.value.trim();
    const mode = modeSelect.value;

    const excluded = {};
    filterGridDiv.querySelectorAll('input[type="checkbox"]:not(:checked)').forEach(cb => {
      const rot = cb.dataset.rotation, blk = cb.dataset.block;
      if (!excluded[blk]) excluded[blk] = new Set();
      excluded[blk].add(rot);
    });
    const rotationFilterActive = Object.keys(excluded).length > 0;

    try {
      if (allSchedules.length === 0) {
        const success = await loadMasterSchedule();
        if (!success) {
          resultDiv.textContent = 'Error reading CSV file.';
          return;
        }
      }

      const filtered = allSchedules.filter(r => {
        const cityMatch = !choice || (r[cityKey] || '').trim() === choice;
        let rotationAllowed = true;
        if (rotationFilterActive) {
          for (let i = 1; i <= numBlocks; i++) {
            const rotation = (r[`Block ${i} Rotation`] || '').trim();
            if (excluded[i] && excluded[i].has(rotation)) { rotationAllowed = false; break; }
          }
        }
        switch (mode) {
          case 'city': return cityMatch;
          case 'rotation': return rotationAllowed;
          case 'and': return cityMatch && rotationAllowed;
          default: return true;
        }
      });

      if (!filtered.length) { resultDiv.textContent = 'No matches found.'; return; }

      const head = Array.from({length:numBlocks},(_,i)=>`<th>Block ${i+1}</th>`).join('');
      let html=`<table><thead><tr><th>Add</th><th>Schedule</th>${head}</tr></thead><tbody>`;
      filtered.forEach(r => {
        const sched = (r[idKey] || '').toString().trim();
        const isInRankList = rankList.some(item => item[idKey] === sched);
        const cells = [];
        for (let i = 1; i <= numBlocks; i++) {
          const rotation = (r[`Block ${i} Rotation`] || '').trim();
          const site = (r[`Block ${i} Site`] || '').trim();
          cells.push(`<td><span class="rotation" style="background-color:${colorFor(rotation)}">${rotation}</span><div class="site">${site}</div></td>`);
        }
        const rowDataString = JSON.stringify(r).replace(/'/g, "&apos;");
        const addButton = `<td><button class="btn-add" data-id='${sched}' data-row='${rowDataString}' ${isInRankList ? 'disabled' : ''}>${isInRankList ? '✓' : '+'}</button></td>`;
        html += `<tr>${addButton}<td>${sched}</td>${cells.join('')}</tr>`;
      });
      html += '</tbody></table>';
      resultDiv.innerHTML = `<strong>Results:</strong><br>${html}`;
    } catch {
      resultDiv.textContent = 'Error reading CSV file.';
    }
  }

  searchBtn.addEventListener('click', searchCSV);

  // --------------------------
  // CSV Download and Upload
  // --------------------------

  // Download current rank list as CSV
downloadCSVBtn.addEventListener('click', () => {
  if (rankList.length === 0) {
    rankListMessageSpan.textContent = 'No items to download.';
    setTimeout(() => (rankListMessageSpan.textContent = ''), 2000);
    return;
  }

  // Build minimal CSV: Rank | Schedule ID
  let csvContent = "Rank,Schedule ID\n";
  rankList.forEach((item, index) => {
    const id = (idKey && item[idKey]) ? item[idKey] : '';
    csvContent += `${index + 1},"${id.replace(/"/g, '""')}"\n`;
  });

  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = 'my_rank_list.csv';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);

  rankListMessageSpan.textContent = 'CSV downloaded!';
  setTimeout(() => (rankListMessageSpan.textContent = ''), 2000);
});

  // Upload a previously saved rank list
  uploadCSVBtn.addEventListener('click', () => {
    uploadCSVInput.click();
  });

uploadCSVBtn.addEventListener('click', () => {
  uploadCSVInput.click();
});

uploadCSVInput.addEventListener('change', async (event) => {
  const file = event.target.files[0];
  if (!file) return;

  // Make sure master schedule is available
  if (allSchedules.length === 0) {
    rankListMessageSpan.textContent = 'Loading master schedule...';
    const ok = await loadMasterSchedule();
    if (!ok) {
      rankListMessageSpan.textContent = 'Error loading master schedule. Cannot upload.';
      setTimeout(() => (rankListMessageSpan.textContent = ''), 2500);
      event.target.value = null;
      return;
    }
    rankListMessageSpan.textContent = '';
  }

  Papa.parse(file, {
    header: true,           // your CSV has headers: Rank,Schedule ID
    skipEmptyLines: true,
    complete: (result) => {
      try {
        // Build ID → full-row map from master
        const idMap = new Map();
        allSchedules.forEach(s => idMap.set(String(s[idKey]).trim(), s));

        // Pull IDs from the uploaded CSV's "Schedule ID" column (header or position-safe)
        const rows = result.data;
        const ids = rows
          .map(r => (r['Schedule ID'] ?? r['schedule id'] ?? r[Object.keys(r)[1]] ?? '').toString().trim())
          .filter(Boolean);

        const newRankList = [];
        let notFound = 0;
        const seen = new Set();

        ids.forEach(id => {
          if (idMap.has(id) && !seen.has(id)) {
            newRankList.push(idMap.get(id));
            seen.add(id);
          } else if (!idMap.has(id)) {
            notFound++;
          }
        });

        rankList = newRankList;
        rankCountSpan.textContent = rankList.length;
        renderRankList();

        rankListMessageSpan.textContent =
          `Uploaded ${rankList.length} item(s)` + (notFound ? ` (${notFound} ID(s) not in master).` : '.');
        setTimeout(() => (rankListMessageSpan.textContent = ''), 3000);
      } catch (e) {
        rankListMessageSpan.textContent = 'Error processing file.';
        setTimeout(() => (rankListMessageSpan.textContent = ''), 2500);
      } finally {
        event.target.value = null;
      }
    },
    error: () => {
      rankListMessageSpan.textContent = 'Failed to read file.';
      setTimeout(() => (rankListMessageSpan.textContent = ''), 2500);
      event.target.value = null;
    }
  });
});
});
</script>
